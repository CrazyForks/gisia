- content_for :breadcrumb do
  - nodes = [*project_breadcrumb_nodes(@project), { label: 'Merge Requests', path: merge_requests_path(@project) }]
  = render 'shared/breadcrumb', nodes: nodes

%div{ class: 'w-full bg-white p-6' }
  %div{ class: 'w-full max-w-6xl mx-auto flex flex-col px-4' }

    %div{ class: 'border-b border-slate-200 mb-6' }
      %div{ class: 'flex items-center justify-between' }
        %nav{ class: 'flex space-x-8' }
          - opened_class = (params[:status].blank? || params[:status] == 'opened') ? 'border-b-2 border-blue-600 pb-4 px-1 text-sm font-medium text-blue-600' : 'border-b-2 border-transparent pb-4 px-1 text-sm font-medium text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors'
          = link_to namespace_project_merge_requests_path(@project.namespace.parent.full_path, @project.namespace.path, status: 'opened'), class: opened_class do
            Open
            %span{ class: 'ml-2 px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs font-medium' }= @project.merge_requests.where(status: 'opened').count

          - merged_class = params[:status] == 'merged' ? 'border-b-2 border-blue-600 pb-4 px-1 text-sm font-medium text-blue-600' : 'border-b-2 border-transparent pb-4 px-1 text-sm font-medium text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors'
          = link_to namespace_project_merge_requests_path(@project.namespace.parent.full_path, @project.namespace.path, status: 'merged'), class: merged_class do
            Merged
            %span{ class: 'ml-2 px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full text-xs font-medium' }= @project.merge_requests.where(status: 'merged').count

          - closed_class = params[:status] == 'closed' ? 'border-b-2 border-blue-600 pb-4 px-1 text-sm font-medium text-blue-600' : 'border-b-2 border-transparent pb-4 px-1 text-sm font-medium text-slate-500 hover:text-slate-700 hover:border-slate-300 transition-colors'
          = link_to namespace_project_merge_requests_path(@project.namespace.parent.full_path, @project.namespace.path, status: 'closed'), class: closed_class do
            Closed
            %span{ class: 'ml-2 px-2 py-0.5 bg-slate-100 text-slate-500 rounded-full text-xs font-medium' }= @project.merge_requests.where(status: 'closed').count

        %div{ class: 'pb-2' }
          = link_to new_namespace_project_merge_request_path(@project.namespace.parent.full_path, @project.namespace.path), class: 'inline-flex items-center gap-2 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-all duration-200 shadow-sm hover:shadow-md' do
            = icon 'plus', class: 'w-4 h-4'
            %span New merge request

    / -- Filters --
    = render 'shared/filters/merge_requests_filters',
      url: namespace_project_merge_requests_path(@project.namespace.parent.full_path, @project.namespace.path),
      clear_url: namespace_project_merge_requests_path(@project.namespace.parent.full_path, @project.namespace.path),
      authors: @authors,
      assignees: @assignees,
      reviewers: @reviewers

    - if @merge_requests&.any?
      %div{ class: 'space-y-0' }
        - @merge_requests.each_with_index do |merge_request, index|
          %div{ class: "group flex items-start gap-4 px-6 py-2 hover:bg-slate-50/50 transition-all duration-200 #{'border-t border-slate-100' if index > 0}" }
            %div{ class: 'flex-shrink-0 mt-0.5' }
              - badge_class = case merge_request.status
              - when 'merged'
                - 'bg-violet-50 text-violet-600 border-violet-200'
              - when 'closed'
                - 'bg-rose-50 text-rose-600 border-rose-200'
              - else
                - 'bg-emerald-50 text-emerald-600 border-emerald-200'
              - icon_name = case merge_request.status
              - when 'merged'
                - 'git-merge'
              - when 'closed'
                - 'archive'
              - else
                - 'git-pull-request'
              - icon_class = case merge_request.status
              - when 'merged'
                - 'text-violet-600'
              - when 'closed'
                - 'text-rose-600'
              - else
                - 'text-emerald-600'
              %div{ class: "w-6 h-6 rounded-full border flex items-center justify-center #{badge_class}" }
                = icon icon_name, class: "w-3.5 h-3.5 #{icon_class}"

            %div{ class: 'flex-1 min-w-0' }
              %div{ class: 'mb-2' }
                %h3{ class: 'text-base font-semibold text-slate-900 hover:text-blue-600 transition-colors cursor-pointer' }
                  = link_to merge_request.title, namespace_project_merge_request_path(id: merge_request.id), class: 'hover:text-blue-600 transition-colors'

              - if merge_request.description.present?
                %p{ class: 'text-sm text-slate-600 mb-3 line-clamp-2' }= truncate(merge_request.description, length: 120)

              %div{ class: 'flex items-center gap-4 text-sm' }
                %div{ class: 'flex items-center gap-2' }
                  %span{ class: 'font-mono text-slate-700 bg-slate-100 px-2 py-1 rounded text-xs' }= merge_request.source_branch
                  = icon 'arrow-right', class: 'w-3 h-3 text-slate-400'
                  %span{ class: 'font-mono text-slate-700 bg-slate-100 px-2 py-1 rounded text-xs' }= merge_request.target_branch

                %div{ class: 'flex items-center gap-2 text-slate-500' }
                  - if merge_request.author&.avatar&.present?
                    = image_tag merge_request.author.avatar_url, class: 'w-4 h-4 rounded-full'
                  - else
                    %div{ class: 'w-4 h-4 rounded-full bg-gradient-to-br from-slate-400 to-slate-500 flex items-center justify-center text-xs font-bold text-white' }
                      = merge_request.author&.name&.first&.upcase || '?'
                  %span
                    opened #{time_ago_in_words(merge_request.created_at)} ago by
                    %span{ class: 'font-medium' }= merge_request.author&.name || 'Unknown'

                - if merge_request.updated_at != merge_request.created_at
                  %div{ class: 'flex items-center gap-1 text-slate-500' }
                    = icon 'clock', class: 'w-3 h-3'
                    %span updated #{time_ago_in_words(merge_request.updated_at)} ago

            %div{ class: 'flex-shrink-0 w-32' }
              - if merge_request.assignees&.any?
                %div{ class: 'flex items-center gap-2' }
                  %div{ class: 'flex -space-x-1' }
                    - merge_request.assignees.first(3).each do |assignee|
                      - if assignee.avatar&.present?
                        = image_tag assignee.avatar_url, class: 'w-6 h-6 rounded-full border-2 border-white', title: assignee.name
                      - else
                        %div{ class: 'w-6 h-6 rounded-full bg-gradient-to-br from-blue-400 to-blue-500 flex items-center justify-center text-xs font-bold text-white border-2 border-white', title: assignee.name }
                          = assignee.name&.first&.upcase || '?'
                    - if merge_request.assignees.count > 3
                      %div{ class: 'w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-xs font-medium text-slate-600 border-2 border-white' }
                        +#{merge_request.assignees.count - 3}
              - else
                %span{ class: 'text-xs text-slate-500' } No assignees

      / -- Pagination --
      = render 'shared/pagination', collection: @merge_requests, url_params: params.except(:page).permit!, turbo_frame: nil

    - else
      %div{ class: 'text-center py-16 bg-white border border-slate-200 rounded-lg' }
        %div{ class: 'mx-auto w-16 h-16 flex items-center justify-center rounded-2xl bg-slate-100 mb-6' }
          = icon 'git-pull-request', class: 'w-8 h-8 text-slate-400'
        %h3{ class: 'text-lg font-semibold text-slate-900 mb-2' } No merge requests yet
        %p{ class: 'text-slate-500 max-w-sm mx-auto leading-relaxed mb-6' }
          Create your first merge request to start collaborating and reviewing code changes.
        = link_to new_namespace_project_merge_request_path(@project.namespace.parent.full_path, @project.namespace.path), class: 'inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200' do
          = icon 'plus', class: 'w-4 h-4'
          %span New merge request

