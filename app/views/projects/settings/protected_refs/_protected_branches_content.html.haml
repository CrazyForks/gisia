- protected_branches = @project.protected_branches

%div{id: 'protected_branches_content', class: 'mb-6'}
  %div{class: 'border border-gray-200 rounded-lg p-4 mb-6'}
    %div{class: 'flex items-start gap-3'}
      %div{class: 'flex-shrink-0 w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center'}
        = icon 'shield-check', class: 'w-4 h-4 text-gray-600'
      %div{class: 'flex-1'}
        %h3{class: 'text-base font-semibold text-gray-900 mb-1'}
          Add Protection Rule
        %p{class: 'text-sm text-gray-600 mb-4'}
          Protect important branches by restricting who can push to them and how
        
        = form_with model: ProtectedBranch.new, url: namespace_project_settings_protected_branches_path(@project.namespace.parent.full_path, @project.namespace.path), html: { class: 'space-y-3' }, data: { turbo_frame: 'protected_branches_frame' } do |f|
          = hidden_field_tag :turbo_frame, 'protected_branches_content'
          
          %div{class: 'grid grid-cols-1 lg:grid-cols-2 gap-4'}
            %div{'data-controller': 'branch-select'}
              - if @project.repository.exists? && @project.repository.branch_names.any?
                = f.label :name, "Branch pattern", class: 'block text-sm font-medium text-gray-900 mb-1', for: 'protected_branch_name_select'
                = f.select :name, options_for_select([['Select branch...', ''], ['Custom pattern...', 'custom']] + @project.repository.branch_names.map { |branch| [branch, branch] }), {}, { id: 'protected_branch_name_select', class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500', 'data-branch-select-target': 'select', 'data-action': 'change->branch-select#handleChange' }
                = f.text_field :name, placeholder: 'e.g., main, develop, release/*', id: 'protected_branch_name_input', class: 'hidden w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500', 'data-branch-select-target': 'customInput', disabled: true
              - else
                = f.label :name, "Branch pattern", class: 'block text-sm font-medium text-gray-900 mb-1', for: 'protected_branch_name_input'
                = f.text_field :name, placeholder: 'e.g., main, develop, release/*', id: 'protected_branch_name_input', class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500'

            %div
              = f.label :access_level, "Required access level", class: 'block text-sm font-medium text-gray-900 mb-1'
              = f.select :access_level, options_for_select([['Developer', 'developer'], ['Maintainer', 'maintainer'], ['Owner', 'owner']], 'developer'), {}, { class: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500' }

          %div{class: 'border-t border-gray-200 pt-3'}
            %h4{class: 'text-sm font-medium text-gray-900 mb-2'}
              Additional permissions
            %div{class: 'grid grid-cols-1 md:grid-cols-3 gap-3'}
              %label{class: 'flex items-center p-2 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer'}
                = f.check_box :allow_push, class: 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
                %div
                  %span{class: 'text-sm font-medium text-gray-900'} Allow push
                  %p{class: 'text-xs text-gray-500'} Users can push commits
              
              %label{class: 'flex items-center p-2 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer'}
                = f.check_box :allow_force_push, class: 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
                %div
                  %span{class: 'text-sm font-medium text-gray-900'} Force push
                  %p{class: 'text-xs text-gray-500'} Allow rewriting history
              
              %label{class: 'flex items-center p-2 border border-gray-200 rounded-md hover:bg-gray-50 cursor-pointer'}
                = f.check_box :allow_merge_to, class: 'mr-2 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500'
                %div
                  %span{class: 'text-sm font-medium text-gray-900'} Allow merge
                  %p{class: 'text-xs text-gray-500'} Can merge pull requests

          %div{class: 'flex justify-end pt-3'}
            = f.submit 'Protect Branch', class: 'px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors'

  - if protected_branches.any?
    %div{class: 'border-t border-gray-200 pt-6'}
      %h3{class: 'text-base font-medium text-gray-900 mb-4'}
        Protected Branches (#{protected_branches.count})
      
      %div{class: 'space-y-3'}
        - protected_branches.each do |protected_branch|
          %div{class: 'flex items-center justify-between p-4 bg-gray-50 rounded-lg'}
            %div{class: 'flex items-center gap-3'}
              = icon 'git-branch', class: 'w-4 h-4 text-gray-500'
              %div
                %div{class: 'font-medium text-gray-900'}= protected_branch.name
                %div{class: 'text-sm text-gray-500'}
                  = protected_branch.access_level.humanize
                  - permissions = []
                  - permissions << 'Push' if protected_branch.allow_push?
                  - permissions << 'Force Push' if protected_branch.allow_force_push?  
                  - permissions << 'Merge' if protected_branch.allow_merge_to?
                  - if permissions.any?
                    Â· #{permissions.join(', ')}
            
            %div{class: 'flex gap-2'}
              = link_to 'Delete', namespace_project_settings_protected_branch_path(@project.namespace.parent.full_path, @project.namespace.path, protected_branch), data: { turbo_method: :delete, turbo_confirm: "Remove protection from #{protected_branch.name}?", turbo_frame: 'protected_branches_content' }, class: 'px-3 py-1 text-xs font-medium text-red-600 bg-red-50 rounded-md hover:bg-red-100 transition-colors'
  - else
    %div{class: 'border-t border-gray-200 pt-6'}
      %div{class: 'text-center py-8 text-gray-500'}
        %div{class: 'w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center'}
          = icon 'shield', class: 'w-8 h-8 text-gray-400'
        %p{class: 'text-sm font-medium text-gray-700'} No protected branches configured
        %p{class: 'text-xs text-gray-500'} Add protection rules above to secure important branches

